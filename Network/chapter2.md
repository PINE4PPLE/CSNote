# 第二章 直连网络

## 一、数据通信的基本概念

### 1. 数字基带信号

根据码元幅度取值可以分为

1. 二元码：0，1。
2. 三元码：正，0，负。
3. 多元码：每个符号可以用多个二进制组码。

#### 2. 常见二元码

|      | 单极性不归零吗                                               | 双极性不归零码 | 单极性归零码                                | 曼彻斯特码                                                   | 差分曼彻斯特码                     |
| ---- | ------------------------------------------------------------ | -------------- | ------------------------------------------- | ------------------------------------------------------------ | ---------------------------------- |
| 特点 |                                                              | -1表示0        | 前半个时钟周期表示信码后半个个时钟周期会归0 | 一个周期的方波表示1，反向方波表示0.                          | 相邻周期的方波反相表示1，同相表示0 |
| 优点 | 简单直观                                                     |                |                                             | ¨码元周期的中间部分存在电平跳变，易于提取时钟，不受信源统计特性的影响；方波周期内，正负电平各一半，不存在直流分量 |                                    |
| 缺点 | 存在大量直流分量，即长串信码呈现固定持续电平，无法提取时钟信号 |                |                                             | ¨比特率为波特率的一半（信号变化的速率为波特率），编码效率仅50% |                                    |



![image text](file:\\D:\计网\note\pic\2.1.png)

![image text](file:\\D:\计网\note\pic\2.2.png)

#### 3. 数字信号调制

1. 幅度键控：载波的振幅随调制信号变化而变化
2. 频移键控：载波的频率随调制信号变化而变化
3. 相移键控：载波的相位随调制信号变化而变化

![image text](file:\\D:\计网\note\pic\2.3.png)

#### 4. 信道容量与计算

香农公式:
$$
C = Wlog_2(1 + \frac{S}{N})
$$
其中，C表示信道容量(bps)，W为信道带宽(Hz)，S为信号平均功率，N为高斯白噪声功率，S/N为信噪比，常表示为SNR(单位为dB)，
$$
SNR = 10log_{10}(\frac{S}{N})
$$

## 二、网络构件

#### 1.结点

网络结点分为主机(端系统)以及网络内部交换节点。

网络适配器：将节点连接到链路的硬件实现大部分数据链路层以及物理层功能(编码，组帧， 差错检测，可靠传输，介质访问控制)。

#### 2. 网络链路

物理层之下的传输媒体，分为导引型(双绞线，同轴电缆，光缆)与非导引型(无线电波，微波，红外线电波)。

链路类型分为点对点链路与广播链路。



## 三、 组帧

1.  面向字节的组帧：起始标记法(特定字符表示帧的开始与结束)，字符填充法(在起始标记法基础上引入转义符DLE)，字节计数法(帧中字节数放在首部的一个字段中)；
2.  面向比特的组帧：SLDC(01111110表示帧的开始与结束)，发送方发送时若出现5个连续的1则立即填入一个0；

## 四、差错检测

数据传输过程中可能出现比特差错，错误比特数/总比特数称为误码率。

差错检测的基本思想为加入冗余信息判断是否存在差错。

### 1. 奇偶效校验

#### 1.1 单向奇偶校验/单个位奇偶校验

使用单个奇偶校验位，偶/奇校验为d比特信息和1比特校验位中1的总数为偶数/奇数。(只能检测奇数个比特差错)

#### 1.2 二维奇偶校验

将d比特信息划分为i行j列，对每行每列计算奇偶值，产生i+j+1个奇偶校验位。

### 2.校验和

将所传输的所有字相加，和作为校验和。

**TCP/IP**协议中使用的发送方反码运算将所有16位字相加，对结果取反码。

（反码运算：由低位至高位运算，最高位进位会娟至最低位）；接受方将所有字相加，若和为全1则认为无差错。

缺点：冗余少，检测能力弱。（1个字加一，一个字减一，校验和不变）；

优点：易于实现，可以满足实际需求。

### 3.循环冗余校验

对消息M，生成多项式C，冗余长度k为C长度-1。

计算冗余消息的算法为

1. T = M << k
2. S = T % C（模2运算）
3. P = T - S(P = T + S)

### 4.纠错

发现错误并纠正，需要的冗余位高于检错，在以下环境使用纠错码：差错发生的可能性高(无线环境)，重传代价高(卫星链路), 无法重传(单工信道)



## 五、可靠传输

差错检测会丢弃出现差错的帧，需要某种方式恢复被丢弃或丢失的帧。

基本机制为确认与超时。

**确认(ACK)**：告知已收到刚才的帧；可以为控制帧或恰好要发向对方的数据帧；

**超时(timeout)**：等待合理时间后未收到确认则重发原始帧。

### 停等算法

基本思想：发送方发送一帧后，在传输下一帧前等待ACK，若等待一定时间未到达则超时重传。

缺点：只允许链路上有一个未确认的帧，使得链路利用率较低。

### 滑动窗口算法

可靠，高效，按序，流量控制。

#### 发送方：

1. 维护三个状态变量：发送窗口大小SWS，最近被确认过的帧的序号LAR，最近发送的帧的序号LFS。
2. 收到ACK后，更新LAR，若窗口允许，发送新的帧，更新LFS；为每个发送帧维护一个定时器，若收到ACK前超时，重传该帧；

#### 接受方：

1. 维护三个状态变量：接收窗口大小RWS，最大的可接受帧的序号LAF，最后确认的帧的序号LFR。
2. 收到帧，若帧在接受窗口内，接受，否则丢弃；接受数据帧后，将收到的最大连续数据帧的seq作为ACK回复。

#### 数据帧丢失时

1. 回退N机制：超时后重传LAR+1至LFS间的所有帧。
2. 选择确认机制：确认每个已接受的数据帧并只重发未接收的帧。

#### 窗口大小

SWS依据时延带宽积；RWS>SWS无意义，RWS = SWS时接受方可以缓存发送方传输的任何帧。

RWS=SWS时，发送窗口不能大于可用序列号的一半。

## 六、媒体共享

### 1. 静态划分信道

#### 1.1 频分复用

将用户分配到一定的频带后，在通信过程中始终占据该频带

![image text](file:\\D:\计网\note\pic\2.4.png)

####  1.2时分复用

将时间划为一段段等长的时分复用帧(TDM帧)

![image text](file:\\D:\计网\note\pic\2.5.png)

####  1.3.统计时分复用

按需动态分配时隙（异步时分复用）。

![image text](file:\\D:\计网\note\pic\2.6.png)

#### 1.4.波分复用

光的频分复用(光载波的频率很高，习惯用波长而非频率表示)

####  1.5.码分复用

每个用户被指派一个唯一的mbit码片的序列，发送比特1则发送码片序列，发送比特0则发送码片序列的二进制反码。

**信道复用**：每个站分配的码片不同且相互正交。则每个站对信号进行归一化内积，值为1则发送方发送比特1，值为-1则发送方发送比特0，值为0则发送方未发送。

### 2.动态媒体接入控制

####  2.1. ALOHA

1. 基本思想：帧首次到达立即发送；若碰撞，则以概率p重传该帧，1-p的概率等待下一个帧传输时间；若不成功，同样以概率p重传该帧。(p坚持)

2. 信道利用率：假设网络有n个节点，则时间t成功条件为[t-1,t]时间没有节点发送，[t, t+1]时间也没有节点发送，概率为
   $$
   P = p(1-p)^{N-1}(1-p)^{N-1}
   $$
   N趋于∞时，利用率为1/2e

#### 2.2时隙ALOHA

1. 设帧长为L，发送速率为R，将时间划分为L/R的时隙，节点只在时隙开始时传输帧。

2. 信道利用率：N趋于∞时，利用率为1/e

#### 2.3载波侦听多点接入(CSMA)

节点在发送前先检测信道，是否有其他结点也在发送，若有则暂时不要发送。

1. 根据侦听/发送策略，CSMA可以分为非持续CSMA，1-坚持CSMA，p-坚持CSMA。p-

![image text](file:\\D:\计网\note\pic\2.7.png)

![image text](file:\\D:\计网\note\pic\2.8.png)

2. 由于信号传播时延导致碰撞使得问题无法被彻底解决。

#### 2.4 带碰撞检测的CSMA(CSMA/CD)

核心思想：1-坚持CSMA+碰撞检测

**侦听/发送**：在信道空闲时等待最小帧间隔时间后发送。(相当于96bits的发送时间，为了使刚刚收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备)

**碰撞处理**：立即停止发送数据并发出特殊的阻塞信息告知其他设备有碰撞的发生，并根据指数退避算法确定推迟时间。

(t = (0,1, ..., 2^k-1) 中任意一个时间， k = min(重传次数， 10) )

超过16次则丢弃该帧并向高层报告。

**碰撞窗口**：以太网端到端往返时延称为碰撞窗口/争用期，帧需要足够长使得发送方在结束前检测到冲突。

#### 2.4 带碰撞避免的CSMA(CSMA/CA)

核心思想：非持续CSMA+碰撞避免

在无线网中由于接收信号强度小于发送信号以及隐藏终端等问题，使得碰撞难以检测；

**侦听/发送**：在信道空闲时第一次尝试发送等待分布式帧间隔时间后发送，否则执行碰撞避免操作发送数据。

**碰撞避免**

1. 信道空闲一段时间(分布式帧间隔时间)后进入竞争窗口，各节点根据重传次数按照二进制指数退避算法选择退避时间，退避完成则发送数据，否则冻结退避计时器，等到信道空闲分布式帧间隔时间后再次计时直至退避完成。

2. 发送，接受节点通过RTS/CTS短帧预约信道，避免碰撞。

## 七、以太网

#### 1.  以太网帧结构

![image text](file:\\D:\计网\note\pic\2.9.png)

数据字段最小长度 = 64 - 18字节首部与尾部



#### 2.以太网主机接收数据的方式

以太网适配器接收所有帧但只接受编址到它自己地址的帧 ，编址到广播地址的帧 ，编址到多点播送地址的帧，如果适配器在监听那个地址 ，所有帧，如果适配器处于混杂模式。



以太网不提供可靠传输，只是尽最大努力交付。

#### 3. 扩展以太网

**物理层**

光纤：扩展主机与hub，hub与hub之间的距离。

hub(集线器)：：扩展为覆盖范围更广、连接结点更多的多级星形结构 。

**数据链路层**

网桥(Bridge),二层交换机(Switch),演变为交换网络，不再是广播域。



P.S.集线器所有接口属于同一碰撞域；交换机每个接口都是一个碰撞域，属于同一广播域；路由器每个接口都是一个广播域